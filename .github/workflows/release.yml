name: Release

on:
  push:
    branches: [main]

concurrency:
  group: release-main
  cancel-in-progress: false

env:
  mad-master: mad-master
  us-east1: us-east1
  us-east1-docker.pkg.dev/mad-master/images: us-east1-docker.pkg.dev/mad-master/images
  CLOUD_RUN_SERVICE: tv-dashboards-dev
  https://tv-dashboards-dev.madhive.dev: https://tv-dashboards-dev.madhive.dev
  tv-dashboards: tv-dashboards

permissions:
  contents: write
  id-token: write

jobs:
  extract-jira-tickets:
    name: Extract Jira Tickets
    runs-on: ubuntu-latest
    outputs:
      tickets: ${{ steps.extract.outputs.tickets }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Extract Jira tickets from commits
        id: extract
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            COMMITS=$(git log "${LAST_TAG}..HEAD" --pretty=format:"%s %b")
          else
            COMMITS=$(git log --pretty=format:"%s %b")
          fi
          TICKETS=$(echo "$COMMITS" | grep -oE '[A-Z]+-[0-9]+' | sort -u | tr '\n' ',' | sed 's/,$//')
          echo "tickets=${TICKETS}" >> "$GITHUB_OUTPUT"
          echo "Found tickets: ${TICKETS:-none}"

  test-and-version:
    name: Test & Version
    runs-on: ubuntu-latest
    needs: [extract-jira-tickets]
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Lint
        run: bun run lint

      - name: Test
        run: bun test

      - name: Determine next version
        id: version
        run: |
          LAST_TAG=$(git describe --tags --match "app-v*" --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            MAJOR=1
            MINOR=0
            PATCH=0
          else
            VERSION="${LAST_TAG#app-v}"
            MAJOR=$(echo "$VERSION" | cut -d. -f1)
            MINOR=$(echo "$VERSION" | cut -d. -f2)
            PATCH=$(echo "$VERSION" | cut -d. -f3)
            PATCH=$((PATCH + 1))
          fi
          VERSION="${MAJOR}.${MINOR}.${PATCH}"
          TAG="app-v${VERSION}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "Next version: ${VERSION} (tag: ${TAG})"

      - name: Create git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.version }}"
          git push origin "${{ steps.version.outputs.tag }}"

  build:
    name: Build & Push Image
    runs-on: ubuntu-latest
    needs: [test-and-version]
    steps:
      - uses: actions/checkout@v6

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker "${{ env.us-east1 }}-docker.pkg.dev" --quiet

      - name: Build and push Docker image
        run: |
          IMAGE_BASE="${{ env.us-east1-docker.pkg.dev/mad-master/images }}/${{ env.tv-dashboards }}"
          IMAGE_VERSIONED="${IMAGE_BASE}:${{ needs.test-and-version.outputs.tag }}"
          IMAGE_LATEST="${IMAGE_BASE}:latest"

          docker build -t "$IMAGE_VERSIONED" -t "$IMAGE_LATEST" .
          docker push "$IMAGE_VERSIONED"
          docker push "$IMAGE_LATEST"

  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: [test-and-version, build]
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run (dev)
        run: |
          IMAGE="${{ env.us-east1-docker.pkg.dev/mad-master/images }}/${{ env.tv-dashboards }}:${{ needs.test-and-version.outputs.tag }}"
          gcloud run deploy "${{ env.CLOUD_RUN_SERVICE }}" \
            --image "$IMAGE" \
            --region "${{ env.us-east1 }}" \
            --project "${{ env.mad-master }}" \
            --platform managed \
            --quiet

      - name: Health check
        run: |
          echo "Waiting for service to be ready..."
          sleep 10
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.https://tv-dashboards-dev.madhive.dev }}/health" || true)
          if [ "$STATUS" = "200" ]; then
            echo "Health check passed"
          else
            echo "Warning: Health check returned status $STATUS"
          fi

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [test-and-version, extract-jira-tickets, deploy-dev]
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Generate release notes
        id: notes
        run: |
          TAG="${{ needs.test-and-version.outputs.tag }}"
          TICKETS="${{ needs.extract-jira-tickets.outputs.tickets }}"
          PREV_TAG=$(git describe --tags --match "app-v*" --abbrev=0 "${TAG}^" 2>/dev/null || echo "")

          {
            echo "notes<<EOF"
            echo "## What's Changed"
            echo ""
            if [ -n "$PREV_TAG" ]; then
              git log "${PREV_TAG}..${TAG}" --pretty=format:"- %s" --no-merges
            else
              git log "${TAG}" --pretty=format:"- %s" --no-merges | head -20
            fi
            echo ""
            if [ -n "$TICKETS" ]; then
              echo ""
              echo "## Jira Tickets"
              echo "$TICKETS" | tr ',' '\n' | while read -r t; do
                echo "- ${t}"
              done
            fi
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "${{ needs.test-and-version.outputs.tag }}" \
            --title "${{ needs.test-and-version.outputs.tag }}" \
            --notes "${{ steps.notes.outputs.notes }}"

  notify-for-approval:
    name: Request Prod Approval
    runs-on: ubuntu-latest
    needs: [test-and-version, extract-jira-tickets, deploy-dev]
    steps:
      - name: Build approval payload
        id: payload
        run: |
          EXPIRY=$(date -u -d "+8 hours" +%s 2>/dev/null || date -u -v+8H +%s)
          PAYLOAD=$(echo -n '{
            "image_tag": "${{ needs.test-and-version.outputs.tag }}",
            "sha": "${{ github.sha }}",
            "run_id": "${{ github.run_id }}",
            "jira_tickets": "${{ needs.extract-jira-tickets.outputs.tickets }}",
            "repository": "${{ github.repository }}",
            "service": "${{ env.tv-dashboards }}",
            "expiry": "'"${EXPIRY}"'"
          }' | base64 -w 0 2>/dev/null || echo -n '{
            "image_tag": "${{ needs.test-and-version.outputs.tag }}",
            "sha": "${{ github.sha }}",
            "run_id": "${{ github.run_id }}",
            "jira_tickets": "${{ needs.extract-jira-tickets.outputs.tickets }}",
            "repository": "${{ github.repository }}",
            "service": "${{ env.tv-dashboards }}",
            "expiry": "'"${EXPIRY}"'"
          }' | base64)
          echo "payload=${PAYLOAD}" >> "$GITHUB_OUTPUT"

      - name: Send approval request to Slack
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üöÄ Ready for Production ‚Äî ${{ env.tv-dashboards }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Version:*\n`${{ needs.test-and-version.outputs.tag }}`" },
                    { "type": "mrkdwn", "text": "*Commit:*\n`${{ github.sha }}`" },
                    { "type": "mrkdwn", "text": "*Jira Tickets:*\n${{ needs.extract-jira-tickets.outputs.tickets || 'N/A' }}" },
                    { "type": "mrkdwn", "text": "*Deployed to:*\nDev ‚úÖ" }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    { "type": "mrkdwn", "text": "‚è≥ This approval expires in 8 hours" }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": { "type": "plain_text", "text": "‚úÖ Promote to Production", "emoji": true },
                      "style": "primary",
                      "action_id": "approve_deployment",
                      "value": "${{ steps.payload.outputs.payload }}"
                    },
                    {
                      "type": "button",
                      "text": { "type": "plain_text", "text": "View Run", "emoji": true },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [test-and-version, build, deploy-dev]
    if: failure()
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚ùå Release Failed ‚Äî ${{ env.tv-dashboards }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Branch:*\n`main`" },
                    { "type": "mrkdwn", "text": "*Commit:*\n`${{ github.sha }}`" }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": { "type": "plain_text", "text": "View Run", "emoji": true },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
