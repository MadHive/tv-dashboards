name: Deploy Production

on:
  repository_dispatch:
    types: [DISPATCH_EVENT_DEPLOY]

env:
  GCP_PROJECT_ID: GCP_PROJECT_ID
  GCP_REGION: GCP_REGION
  GCP_ARTIFACT_REGISTRY: GCP_ARTIFACT_REGISTRY
  CLOUD_RUN_SERVICE: CLOUD_RUN_SERVICE_PROD
  PROD_URL: PROD_URL
  APP_NAME: APP_NAME

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run (prod)
        run: |
          IMAGE="${{ env.GCP_ARTIFACT_REGISTRY }}/${{ env.APP_NAME }}:${{ github.event.client_payload.image_tag }}"
          gcloud run deploy "${{ env.CLOUD_RUN_SERVICE }}" \
            --image "$IMAGE" \
            --region "${{ env.GCP_REGION }}" \
            --project "${{ env.GCP_PROJECT_ID }}" \
            --platform managed \
            --min-instances 1 \
            --session-affinity \
            --quiet

      - name: Health check
        run: |
          echo "Waiting for service to be ready..."
          sleep 15
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.PROD_URL }}/health" || true)
          if [ "$STATUS" = "200" ]; then
            echo "Health check passed"
          else
            echo "Warning: Health check returned status $STATUS"
          fi

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [deploy]
    steps:
      - name: Build rollback payload
        id: rollback_payload
        run: |
          PAYLOAD=$(echo -n '{
            "service": "${{ env.APP_NAME }}",
            "repository": "${{ github.repository }}",
            "image_tag": "${{ github.event.client_payload.image_tag }}",
            "sha": "${{ github.event.client_payload.sha }}"
          }' | base64 -w 0 2>/dev/null || echo -n '{
            "service": "${{ env.APP_NAME }}",
            "repository": "${{ github.repository }}",
            "image_tag": "${{ github.event.client_payload.image_tag }}",
            "sha": "${{ github.event.client_payload.sha }}"
          }' | base64)
          echo "payload=${PAYLOAD}" >> "$GITHUB_OUTPUT"

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üéâ Deployed to Production ‚Äî ${{ env.APP_NAME }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Version:*\n`${{ github.event.client_payload.image_tag }}`" },
                    { "type": "mrkdwn", "text": "*Approved by:*\n${{ github.event.client_payload.approved_by }}" },
                    { "type": "mrkdwn", "text": "*Commit:*\n`${{ github.event.client_payload.sha }}`" },
                    { "type": "mrkdwn", "text": "*Environment:*\nProduction ‚úÖ" }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": { "type": "plain_text", "text": "Open Production", "emoji": true },
                      "url": "${{ env.PROD_URL }}"
                    },
                    {
                      "type": "button",
                      "text": { "type": "plain_text", "text": "‚ö†Ô∏è Rollback", "emoji": true },
                      "style": "danger",
                      "action_id": "rollback_deployment",
                      "value": "${{ steps.rollback_payload.outputs.payload }}"
                    }
                  ]
                }
              ]
            }

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [deploy]
    if: failure()
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚ùå Production Deploy Failed ‚Äî ${{ env.APP_NAME }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Version:*\n`${{ github.event.client_payload.image_tag }}`" },
                    { "type": "mrkdwn", "text": "*Approved by:*\n${{ github.event.client_payload.approved_by }}" }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": { "type": "plain_text", "text": "View Run", "emoji": true },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
