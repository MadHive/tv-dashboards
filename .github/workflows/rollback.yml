name: Rollback

on:
  repository_dispatch:
    types: [tv-dashboards-rollback]

env:
  mad-master: mad-master
  us-east1: us-east1
  CLOUD_RUN_SERVICE: tv-dashboards
  https://tv-dashboards.madhive.dev: https://tv-dashboards.madhive.dev
  tv-dashboards: tv-dashboards

permissions:
  contents: read
  id-token: write

jobs:
  rollback:
    name: Rollback Production
    runs-on: ubuntu-latest
    outputs:
      previous_revision: ${{ steps.rollback.outputs.previous_revision }}
      current_revision: ${{ steps.rollback.outputs.current_revision }}
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Rollback to previous revision
        id: rollback
        run: |
          # List revisions sorted by creation time
          REVISIONS=$(gcloud run revisions list \
            --service "${{ env.CLOUD_RUN_SERVICE }}" \
            --region "${{ env.us-east1 }}" \
            --project "${{ env.mad-master }}" \
            --format "value(REVISION)" \
            --sort-by "~creationTimestamp" \
            --limit 2)

          CURRENT=$(echo "$REVISIONS" | head -1)
          PREVIOUS=$(echo "$REVISIONS" | tail -1)

          if [ -z "$PREVIOUS" ] || [ "$CURRENT" = "$PREVIOUS" ]; then
            echo "Error: No previous revision available to rollback to"
            exit 1
          fi

          echo "Rolling back from $CURRENT to $PREVIOUS"
          echo "current_revision=${CURRENT}" >> "$GITHUB_OUTPUT"
          echo "previous_revision=${PREVIOUS}" >> "$GITHUB_OUTPUT"

          # Route 100% traffic to previous revision
          gcloud run services update-traffic "${{ env.CLOUD_RUN_SERVICE }}" \
            --region "${{ env.us-east1 }}" \
            --project "${{ env.mad-master }}" \
            --to-revisions "${PREVIOUS}=100"

      - name: Health check
        run: |
          echo "Waiting for rollback to propagate..."
          sleep 10
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.https://tv-dashboards.madhive.dev }}/health" || true)
          if [ "$STATUS" = "200" ]; then
            echo "Health check passed after rollback"
          else
            echo "Warning: Health check returned status $STATUS"
          fi

  notify-success:
    name: Notify Rollback Success
    runs-on: ubuntu-latest
    needs: [rollback]
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "⏪ Rollback Complete — ${{ env.tv-dashboards }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Rolled back from:*\n`${{ needs.rollback.outputs.current_revision }}`" },
                    { "type": "mrkdwn", "text": "*Rolled back to:*\n`${{ needs.rollback.outputs.previous_revision }}`" },
                    { "type": "mrkdwn", "text": "*Triggered by:*\n${{ github.event.client_payload.approved_by || github.actor }}" },
                    { "type": "mrkdwn", "text": "*Environment:*\nProduction" }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": { "type": "plain_text", "text": "Open Production", "emoji": true },
                      "url": "${{ env.https://tv-dashboards.madhive.dev }}"
                    },
                    {
                      "type": "button",
                      "text": { "type": "plain_text", "text": "View Run", "emoji": true },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }

  notify-failure:
    name: Notify Rollback Failure
    runs-on: ubuntu-latest
    needs: [rollback]
    if: failure()
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "❌ Rollback Failed — ${{ env.tv-dashboards }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "⚠️ *Manual intervention required.* The automatic rollback for `${{ env.tv-dashboards }}` failed. Please check the Cloud Run console and roll back manually."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": { "type": "plain_text", "text": "View Run", "emoji": true },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    },
                    {
                      "type": "button",
                      "text": { "type": "plain_text", "text": "Cloud Run Console", "emoji": true },
                      "url": "https://console.cloud.google.com/run/detail/${{ env.us-east1 }}/${{ env.CLOUD_RUN_SERVICE }}/revisions?project=${{ env.mad-master }}"
                    }
                  ]
                }
              ]
            }
