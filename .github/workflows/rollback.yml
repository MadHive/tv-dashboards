name: Rollback

on:
  repository_dispatch:
    types: [DISPATCH_EVENT_ROLLBACK]

env:
  GCP_PROJECT_ID: GCP_PROJECT_ID
  GCP_REGION: GCP_REGION
  CLOUD_RUN_SERVICE: CLOUD_RUN_SERVICE_PROD
  PROD_URL: PROD_URL
  APP_NAME: APP_NAME

permissions:
  contents: read
  id-token: write

jobs:
  rollback:
    name: Rollback Production
    runs-on: ubuntu-latest
    outputs:
      previous_revision: ${{ steps.rollback.outputs.previous_revision }}
      current_revision: ${{ steps.rollback.outputs.current_revision }}
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Rollback to previous revision
        id: rollback
        run: |
          # List revisions sorted by creation time
          REVISIONS=$(gcloud run revisions list \
            --service "${{ env.CLOUD_RUN_SERVICE }}" \
            --region "${{ env.GCP_REGION }}" \
            --project "${{ env.GCP_PROJECT_ID }}" \
            --format "value(REVISION)" \
            --sort-by "~creationTimestamp" \
            --limit 2)

          CURRENT=$(echo "$REVISIONS" | head -1)
          PREVIOUS=$(echo "$REVISIONS" | tail -1)

          if [ -z "$PREVIOUS" ] || [ "$CURRENT" = "$PREVIOUS" ]; then
            echo "Error: No previous revision available to rollback to"
            exit 1
          fi

          echo "Rolling back from $CURRENT to $PREVIOUS"
          echo "current_revision=${CURRENT}" >> "$GITHUB_OUTPUT"
          echo "previous_revision=${PREVIOUS}" >> "$GITHUB_OUTPUT"

          # Route 100% traffic to previous revision
          gcloud run services update-traffic "${{ env.CLOUD_RUN_SERVICE }}" \
            --region "${{ env.GCP_REGION }}" \
            --project "${{ env.GCP_PROJECT_ID }}" \
            --to-revisions "${PREVIOUS}=100"

      - name: Health check
        run: |
          echo "Waiting for rollback to propagate..."
          sleep 10
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.PROD_URL }}/health" || true)
          if [ "$STATUS" = "200" ]; then
            echo "Health check passed after rollback"
          else
            echo "Warning: Health check returned status $STATUS"
          fi

  notify-success:
    name: Notify Rollback Success
    runs-on: ubuntu-latest
    needs: [rollback]
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "⏪ Rollback Complete — ${{ env.APP_NAME }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Rolled back from:*\n`${{ needs.rollback.outputs.current_revision }}`" },
                    { "type": "mrkdwn", "text": "*Rolled back to:*\n`${{ needs.rollback.outputs.previous_revision }}`" },
                    { "type": "mrkdwn", "text": "*Triggered by:*\n${{ github.event.client_payload.approved_by || github.actor }}" },
                    { "type": "mrkdwn", "text": "*Environment:*\nProduction" }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": { "type": "plain_text", "text": "Open Production", "emoji": true },
                      "url": "${{ env.PROD_URL }}"
                    },
                    {
                      "type": "button",
                      "text": { "type": "plain_text", "text": "View Run", "emoji": true },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }

  notify-failure:
    name: Notify Rollback Failure
    runs-on: ubuntu-latest
    needs: [rollback]
    if: failure()
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "❌ Rollback Failed — ${{ env.APP_NAME }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "⚠️ *Manual intervention required.* The automatic rollback for `${{ env.APP_NAME }}` failed. Please check the Cloud Run console and roll back manually."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": { "type": "plain_text", "text": "View Run", "emoji": true },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    },
                    {
                      "type": "button",
                      "text": { "type": "plain_text", "text": "Cloud Run Console", "emoji": true },
                      "url": "https://console.cloud.google.com/run/detail/${{ env.GCP_REGION }}/${{ env.CLOUD_RUN_SERVICE }}/revisions?project=${{ env.GCP_PROJECT_ID }}"
                    }
                  ]
                }
              ]
            }
